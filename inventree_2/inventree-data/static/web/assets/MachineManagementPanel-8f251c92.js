import{j as e,ao as X,r as f,G as j,h as u,y as L,i as n,ar as O,B as S,x as z,n as D,I as P,S as g,T as b,bh as ee,am as B,aJ as I,$,m as Y,ad as se,e1 as k,e3 as G,E as K}from"./vendor-580d7f6a.js";import{T as x}from"./BaseContext-71d55e61.js";import{A as F,i as M,g as A}from"./index-539d0685.js";import{u as E,L as Q}from"./DesktopAppView-f36ad07f.js";import{A as ie}from"./AddItemButton-9bde5586.js";import{A as te,E as re,D as ne}from"./ActionDropdown-0b7f88be.js";import{I as c}from"./InfoItem-0edf1cea.js";import{Y as U}from"./YesNoButton-cd4c504e.js";import{D as N}from"./DetailDrawer-7bb74add.js";import{a as le,S as ae}from"./Instance-4f17d9b0.js";import{M as J}from"./SettingList-5fd10bc0.js";import{a as oe,b as de}from"./ApiForm-173d0ec5.js";import{a as ce}from"./UseForm-5e9a21d6.js";import{u as R,I as V}from"./InvenTreeTable-7dffc519.js";import{B as q}from"./ColumnRenderers-c7f5177c.js";import"./notifications-b554622d.js";import"./StylishText-5ee5b946.js";import"./ProgressBar-f667695e.js";function W(){return e.jsx(X,{size:18,color:"red"})}function Z({machine:t}){const o={marginLeft:"4px"};if(!t.active)return e.jsx(O,{sx:o,color:"gray",children:e.jsx(S,{})});let l="green";t.machine_errors.length>0||!t.is_driver_available||t.status>=300?l="red":t.status>=200&&(l="orange");const a=t.initialized&&t.status>0&&t.status<300;return e.jsx(O,{processing:a,sx:o,color:l,children:e.jsx(S,{})})}function T({includeTypes:t=!0,includeDrivers:o=!0}={}){const{data:l,isFetching:s,refetch:a}=z({enabled:t,queryKey:["machine-types"],queryFn:()=>A.get(M(F.machine_types_list)).then(p=>p.data),staleTime:1e4}),{data:i,isFetching:h,refetch:v}=z({enabled:o,queryKey:["machine-drivers"],queryFn:()=>A.get(M(F.machine_driver_list)).then(p=>p.data),staleTime:10*1e3}),y=f.useCallback(()=>{a(),v()},[v,a]);return{machineTypes:l,machineDrivers:i,isFetching:s||h,refresh:y}}function xe({machinePk:t,refreshTable:o}){const l=E(),{data:s,refetch:a,isFetching:i}=z({enabled:!0,queryKey:["machine-detail",t],queryFn:()=>A.get(M(F.machine_list,t)).then(d=>d.data)}),{machineTypes:h,machineDrivers:v,isFetching:y}=T(),p=i||y,_=f.useMemo(()=>h&&s?h.find(d=>d.slug===s.machine_type):void 0,[s==null?void 0:s.machine_type,h]),m=f.useMemo(()=>v&&s?v.find(d=>d.slug===s.driver):void 0,[s==null?void 0:s.driver,v]),C=f.useCallback(()=>{a(),o()},[a,o]),r=f.useCallback(d=>{A.post(M(F.machine_restart,void 0,{machine:d})).then(()=>{C(),D.show({message:n._({id:"8hvWaA"}),color:"green",icon:e.jsx(P,{size:"1rem"})})})},[C]);return e.jsxs(g,{spacing:"xs",children:[e.jsxs(j,{position:"apart",children:[e.jsx(S,{}),e.jsxs(j,{children:[s&&e.jsx(Z,{machine:s}),e.jsx(b,{order:4,children:s==null?void 0:s.name})]}),e.jsxs(j,{children:[(s==null?void 0:s.restart_required)&&e.jsx(L,{color:"red",children:e.jsx(x,{id:"dKwnjv"})}),e.jsx(te,{tooltip:n._({id:"72f9dQ"}),icon:e.jsx(ee,{}),actions:[re({tooltip:n._({id:"RBquff"}),onClick:()=>{oe({title:n._({id:"RBquff"}),url:F.machine_list,pk:t,fields:{name:{},active:{}},onClose:()=>C()})}}),ne({tooltip:n._({id:"5ihjEH"}),onClick:()=>{de({title:n._({id:"5ihjEH"}),successMessage:n._({id:"ZbXCol"}),url:F.machine_list,pk:t,preFormContent:e.jsx(u,{children:n._({id:"Y9eJUJ",values:{0:s==null?void 0:s.name}})}),onFormSuccess:()=>{o(),l(-1)}})}}),{icon:e.jsx(B,{}),name:n._({id:"6z9W13"}),tooltip:n._({id:"Plnldt"})+(s!=null&&s.restart_required?" ("+n._({id:"kbLjlB"})+")":""),indicator:s!=null&&s.restart_required?{color:"red"}:void 0,onClick:()=>s&&r(s==null?void 0:s.pk)}]})]})]}),e.jsx(I,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(j,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"TXZA6i"})}),e.jsx($,{variant:"outline",onClick:()=>a(),children:e.jsx(B,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:p,overlayOpacity:0}),e.jsx(c,{name:n._({id:"pwL+bm"}),children:e.jsxs(j,{spacing:"xs",children:[_?e.jsx(Q,{to:`../type-${s==null?void 0:s.machine_type}`,children:e.jsx(u,{children:_.name})}):e.jsx(u,{children:s==null?void 0:s.machine_type}),s&&!_&&e.jsx(W,{})]})}),e.jsx(c,{name:n._({id:"3ADt1I"}),children:e.jsxs(j,{spacing:"xs",children:[m?e.jsx(Q,{to:`../driver-${s==null?void 0:s.driver}`,children:e.jsx(u,{children:m.name})}):e.jsx(u,{children:s==null?void 0:s.driver}),!(s!=null&&s.is_driver_available)&&e.jsx(W,{})]})}),e.jsx(c,{name:n._({id:"nsu9Un"}),children:e.jsx(U,{value:(s==null?void 0:s.initialized)||!1})}),e.jsx(c,{name:n._({id:"F6pfE9"}),children:e.jsx(U,{value:(s==null?void 0:s.active)||!1})}),e.jsx(c,{name:n._({id:"uAQUqI"}),children:e.jsxs(se,{direction:"column",children:[(s==null?void 0:s.status)===-1?e.jsx(u,{fz:"xs",children:"No status"}):ae({status:`${(s==null?void 0:s.status)||-1}`,type:`MachineStatus__${s==null?void 0:s.status_model}`}),e.jsx(u,{fz:"sm",children:s==null?void 0:s.status_text})]})}),e.jsxs(j,{position:"apart",spacing:"xs",children:[e.jsxs(u,{fz:"sm",fw:700,children:[e.jsx(x,{id:"UirGxE"}),":"]}),s&&(s==null?void 0:s.machine_errors.length)>0?e.jsx(L,{color:"red",sx:{marginLeft:"10px"},children:s==null?void 0:s.machine_errors.length}):e.jsx(u,{fz:"xs",children:e.jsx(x,{id:"hIOaIF"})}),e.jsx(k,{w:"100%",children:s==null?void 0:s.machine_errors.map((d,w)=>e.jsx(k.Item,{children:e.jsx(G,{children:d})},w))})]})]})]})}),e.jsx(K,{h:"10px"}),(s==null?void 0:s.is_driver_available)&&e.jsxs(e.Fragment,{children:[e.jsxs(I,{withBorder:!0,children:[e.jsx(b,{order:5,pb:4,children:e.jsx(x,{id:"m57e2B"})}),e.jsx(J,{machinePk:t,configType:"M",onChange:C})]}),e.jsxs(I,{withBorder:!0,children:[e.jsx(b,{order:5,pb:4,children:e.jsx(x,{id:"fWJCep"})}),e.jsx(J,{machinePk:t,configType:"D",onChange:C})]})]})]})}function H({props:t,renderMachineDrawer:o=!0,createProps:l}){const{machineTypes:s,machineDrivers:a}=T(),i=R("machine"),h=E(),v=f.useMemo(()=>[{accessor:"name",sortable:!0,render:function(r){return e.jsxs(j,{position:"left",noWrap:!0,children:[e.jsx(Z,{machine:r}),e.jsx(u,{children:r.name}),r.restart_required&&e.jsx(L,{color:"red",children:e.jsx(x,{id:"dKwnjv"})})]})}},{accessor:"machine_type",sortable:!0,render:r=>{const d=s==null?void 0:s.find(w=>w.slug===r.machine_type);return e.jsxs(j,{spacing:"xs",children:[e.jsx(u,{children:d?d.name:r.machine_type}),s&&!d&&e.jsx(W,{})]})}},{accessor:"driver",sortable:!0,render:r=>{const d=a==null?void 0:a.find(w=>w.slug===r.driver);return e.jsxs(j,{spacing:"xs",children:[e.jsx(u,{children:d?d.name:r.driver}),!r.is_driver_available&&e.jsx(W,{})]})}},q({accessor:"initialized"}),q({accessor:"active"}),{accessor:"status",sortable:!1,render:r=>{const d=le(`MachineStatus__${r.status_model}`);if(d&&r.status!==-1)return d(r)}}],[s]),[y,p]=f.useState(null),_=f.useMemo(()=>a?a.filter(r=>r.machine_type===y).map(r=>({value:r.slug,display_name:r.name})):[],[a,y]),m=ce({title:n._({id:"2Whws6"}),url:F.machine_list,fields:{name:{},machine_type:{hidden:!!(l!=null&&l.machine_type),...l!=null&&l.machine_type?{value:l.machine_type}:{},field_type:"choice",choices:s?s.map(r=>({value:r.slug,display_name:r.name})):[],onValueChange:r=>p(r)},driver:{hidden:!!(l!=null&&l.driver),...l!=null&&l.driver?{value:l.driver}:{},field_type:"choice",disabled:!y,choices:_},active:{}},onFormSuccess:r=>{i.refreshTable(),h(o?`machine-${r.pk}/`:`../machine-${r.pk}/`)},onClose:()=>{p(null)}}),C=f.useMemo(()=>[e.jsx(ie,{variant:"outline",onClick:()=>{p(null),m.open()}})],[m.open]);return e.jsxs(e.Fragment,{children:[m.modal,o&&e.jsx(N,{title:n._({id:"dGaozN"}),size:"lg",renderContent:r=>!r||!r.startsWith("machine-")?!1:e.jsx(xe,{machinePk:r.replace("machine-",""),refreshTable:i.refreshTable})}),e.jsx(V,{url:M(F.machine_list),tableState:i,columns:v,props:{...t,enableDownload:!1,onRowClick:r=>h(o?`machine-${r.pk}/`:`../machine-${r.pk}/`),tableActions:C,params:{...t.params},tableFilters:[{name:"active",type:"boolean"},{name:"machine_type",type:"choice",choiceFunction:()=>s?s.map(r=>({value:r.slug,label:r.name})):[]},{name:"driver",type:"choice",choiceFunction:()=>a?a.map(r=>({value:r.slug,label:r.name})):[]}]}})]})}function ue({machineTypeSlug:t}){var y,p,_;const o=E(),{machineTypes:l,refresh:s,isFetching:a}=T({includeDrivers:!1}),i=f.useMemo(()=>l==null?void 0:l.find(m=>m.slug===t),[l,t]),h=R("machineDrivers"),v=f.useMemo(()=>[{accessor:"name",title:n._({id:"6YtxFj"})},{accessor:"description",title:n._({id:"Nu4oKW"})},q({accessor:"is_builtin",title:n._({id:"argeGI"})})],[]);return e.jsxs(g,{children:[e.jsx(j,{position:"center",children:e.jsx(b,{order:4,children:i?i.name:t})}),!i&&e.jsx(u,{italic:!0,children:e.jsx(x,{id:"FW2Ygg"})}),e.jsx(I,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(j,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"IBrg3Y"})}),e.jsx($,{variant:"outline",onClick:()=>s(),children:e.jsx(B,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:a,overlayOpacity:0}),e.jsx(c,{name:n._({id:"6YtxFj"}),value:i==null?void 0:i.name,type:"text"}),e.jsx(c,{name:n._({id:"L85WcV"}),value:i==null?void 0:i.slug,type:"text"}),e.jsx(c,{name:n._({id:"Nu4oKW"}),value:i==null?void 0:i.description,type:"text"}),!(i!=null&&i.is_builtin)&&e.jsx(c,{name:n._({id:"umAemZ"}),value:(y=i==null?void 0:i.provider_plugin)==null?void 0:y.name,type:"text",link:((p=i==null?void 0:i.provider_plugin)==null?void 0:p.pk)!==null?`../../plugin/${(_=i==null?void 0:i.provider_plugin)==null?void 0:_.pk}/`:void 0}),e.jsx(c,{name:n._({id:"jfVQG5"}),value:i==null?void 0:i.provider_file,type:"code"}),e.jsx(c,{name:n._({id:"++LBSt"}),value:i==null?void 0:i.is_builtin,type:"boolean"})]})]})}),e.jsx(I,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"7wk8VI"})}),e.jsx(V,{url:M(F.machine_driver_list),tableState:h,columns:v,props:{dataFormatter:m=>m.filter(C=>C.machine_type===t),enableDownload:!1,enableSearch:!1,onRowClick:m=>o(`../driver-${m.slug}/`)}})]})})]})}function je({machineDriverSlug:t}){var v,y,p;const{machineDrivers:o,machineTypes:l,refresh:s,isFetching:a}=T(),i=f.useMemo(()=>o==null?void 0:o.find(_=>_.slug===t),[o,t]),h=f.useMemo(()=>l==null?void 0:l.find(_=>_.slug===(i==null?void 0:i.machine_type)),[o,l]);return e.jsxs(g,{children:[e.jsx(j,{position:"center",children:e.jsx(b,{order:4,children:i?i.name:t})}),!i&&e.jsx(u,{italic:!0,children:e.jsx(x,{id:"p6inm0"})}),e.jsx(I,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsxs(j,{position:"apart",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"Dm7Jy5"})}),e.jsx($,{variant:"outline",onClick:()=>s(),children:e.jsx(B,{})})]}),e.jsxs(g,{pos:"relative",spacing:"xs",children:[e.jsx(Y,{visible:a,overlayOpacity:0}),e.jsx(c,{name:n._({id:"6YtxFj"}),value:i==null?void 0:i.name,type:"text"}),e.jsx(c,{name:n._({id:"L85WcV"}),value:i==null?void 0:i.slug,type:"text"}),e.jsx(c,{name:n._({id:"Nu4oKW"}),value:i==null?void 0:i.description,type:"text"}),e.jsx(c,{name:n._({id:"I+nMNp"}),value:h?h.name:i==null?void 0:i.machine_type,type:"text",link:h?`../type-${i==null?void 0:i.machine_type}`:void 0}),!(i!=null&&i.is_builtin)&&e.jsx(c,{name:n._({id:"umAemZ"}),value:(v=i==null?void 0:i.provider_plugin)==null?void 0:v.name,type:"text",link:((y=i==null?void 0:i.provider_plugin)==null?void 0:y.pk)!==null?`../../plugin/${(p=i==null?void 0:i.provider_plugin)==null?void 0:p.pk}/`:void 0}),e.jsx(c,{name:n._({id:"jfVQG5"}),value:i==null?void 0:i.provider_file,type:"code"}),e.jsx(c,{name:n._({id:"++LBSt"}),value:i==null?void 0:i.is_builtin,type:"boolean"}),e.jsxs(j,{position:"apart",spacing:"xs",children:[e.jsxs(u,{fz:"sm",fw:700,children:[e.jsx(x,{id:"UirGxE"}),":"]}),i&&(i==null?void 0:i.driver_errors.length)>0?e.jsx(L,{color:"red",sx:{marginLeft:"10px"},children:i.driver_errors.length}):e.jsx(u,{fz:"xs",children:e.jsx(x,{id:"hIOaIF"})}),e.jsx(k,{w:"100%",children:i==null?void 0:i.driver_errors.map((_,m)=>e.jsx(k.Item,{children:e.jsx(G,{children:_})},m))})]})]})]})}),e.jsx(I,{withBorder:!0,children:e.jsxs(g,{spacing:"md",children:[e.jsx(b,{order:4,children:e.jsx(x,{id:"Qf5DYN"})}),e.jsx(H,{props:{params:{driver:t}},renderMachineDrawer:!1,createProps:{machine_type:i==null?void 0:i.machine_type,driver:t}})]})})]})}function pe({props:t}){const o=R("machineTypes"),l=E(),s=f.useMemo(()=>[{accessor:"name",title:n._({id:"6YtxFj"})},{accessor:"description",title:n._({id:"Nu4oKW"})},q({accessor:"is_builtin",title:n._({id:"eBtH/D"})})],[]);return e.jsxs(e.Fragment,{children:[e.jsx(N,{title:n._({id:"9Lc7+e"}),size:"lg",renderContent:a=>!a||!a.startsWith("type-")?!1:e.jsx(ue,{machineTypeSlug:a.replace("type-","")})}),e.jsx(N,{title:n._({id:"VDbgpF"}),size:"lg",renderContent:a=>!a||!a.startsWith("driver-")?!1:e.jsx(je,{machineDriverSlug:a.replace("driver-","")})}),e.jsx(V,{url:M(F.machine_types_list),tableState:o,columns:s,props:{...t,enableDownload:!1,enableSearch:!1,onRowClick:a=>l(`type-${a.slug}/`),params:{...t.params}}})]})}function qe(){var l;const{data:t,refetch:o}=z({queryKey:["machine-registry-status"],queryFn:()=>A.get(M(F.machine_registry_status)).then(s=>s.data),staleTime:1e4});return e.jsxs(g,{children:[e.jsx(H,{props:{}}),e.jsx(K,{h:"10px"}),e.jsxs(g,{spacing:"xs",children:[e.jsx(b,{order:5,children:e.jsx(x,{id:"LuGy8Q"})}),e.jsx(pe,{props:{}})]}),e.jsx(K,{h:"10px"}),e.jsxs(g,{spacing:"xs",children:[e.jsxs(j,{children:[e.jsx(b,{order:5,children:e.jsx(x,{id:"1ctV9a"})}),e.jsx($,{variant:"outline",onClick:()=>o(),children:e.jsx(B,{})})]}),t!=null&&t.registry_errors&&t.registry_errors.length===0?e.jsx(u,{italic:!0,children:e.jsx(x,{id:"LK9cs2"})}):e.jsx(k,{children:(l=t==null?void 0:t.registry_errors)==null?void 0:l.map((s,a)=>e.jsx(k.Item,{children:e.jsx(G,{children:s.message})},a))})]})]})}export{qe as default};
